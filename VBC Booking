CREATE OR REPLACE VIEW EDW_DEV.SANDBOX_AMITTAL.BI_BOOKING_v3 AS 
SELECT
V_A.BUSINESS_TYPE_DESCRIPTION AS business_type,
cast(T_B.BKNG_DTTM AS date) AS BOOKING_DATE,
cast(T_B.SALE_DTTM AS date) AS SALE_DATE,
T_BT.BKNG_TYP_DSC AS BOOKING_TYPE,
T_O.ORDR_NUM AS ORDER_NUMBER,
T_OT.ORDR_TYP_DSC AS ORDER_TYPE,
T_OH.ORDR_ID_IN_SRC AS order_id_in_source,
V_A.ACCOUNT_NUMBER,
V_A.ACCOUNT_NAME,
V_A.ACTIVATION_DATE,
V_A.TERMINATION_DATE,
V_A.ACCOUNT_STATUS,
V_A.ACCOUNT_TYPE,
V_A.ACCOUNT_CANCEL_CATEGORY,
V_A.ACCOUNT_CANCEL_REASON,
V_A.ACCOUNT_INDUSTRY,
V_A.ACCOUNT_ERP_ID,
V_A.PARENT_ACCOUNT_NUMBER,
V_A.PARENT_ACCOUNT_NAME,
V_A.PARENT_ACCOUNT_TYPE,
V_A.PARENT_ACCOUNT_STATUS,
V_A.PARENT_ERP_ID AS PARENT_ACCOUNT_ERP_ID,
V_A.PARTNER_ACCOUNT_NUMBER,
V_A.PARTNER_ACCOUNT_NAME,
V_A.PARTNER_ACCOUNT_TYPE,
V_A.PARTNER_ERP_ID AS PARTNER_ACCOUNT_ERP_ID,
V_A.PARENT_PARTNER_ACCOUNT_NUMBER,
V_A.PARENT_PARTNERT_ACCOUNT_NAME,
V_A.PARENT_PARTNER_ACCOUNT_TYPE,
V_A.PARENT_PARTNER_ERP_ID AS PARENT_PARTNER_ACCOUNT_ERP_ID,
V_A.VIP_ACCOUNT_TYPE,
--OWNR_ASSC_ID,
--SEC_OWNR_ASSC_ID
--V_A.SOURCED_BY_FIRST_NAME
--V_A.SOURCED_BY_LAST_NAME
--V_A.SOURCED_BY_PHONE_NUMBER
--V_A.SOURCED_BY_MOBILE_PHONE
--V_A.SOURCED_BY_EMAIL_ADDRESS
V_A.BUSINESS_TYPE_CODE,
V_A.BUSINESS_TYPE_DESCRIPTION,
V_A.BUSINESS_TYPE_GROUP,
T_C.CMPGN_NM AS CAMPAIGN_NAME,
T_C.SCR_CARD_BCKT AS CAMPAIGN_BUCKET,
T_P.PROD_NM AS PRODUCT_NAME,
T_P.PROD_CHRG_NM AS CHARGE_NAME,
T_P.PROD_CHRG_CD AS CHARGE_CODE,
T_P.PROD_CHRG_MDL AS CHARGE_MODEL,
T_P.PROD_CHRG_TYP AS CHARGE_TYPE,
T_P.PROD_PLN_NM AS RATE_PLAN_NAME,
T_P.PROD_CATG AS PRODUCT_CATEGORY,
T_P.PROD_TYP AS PRODUCT_TYPE,
T_P.PROD_FMLY AS PRODUCT_FAMILY,
T_P.PROD_SKU AS PRODUCT_SKU,
COALESCE(T_P.GL_CD, SUBSTRING(T_P.ACCTNG_CD,5,5)) AS GL_CODE,
T_B.GRSS_BKNG_AMT AS GROSS_BOOKING_AMOUNT,
T_B.COMM_BKNG_AMT AS COMMISSIONABLE_BOOKING_AMOUNT,
(T_ASSC.ASSC_FNM || ' ' || T_ASSC.ASSC_LNM) AS AGENT_NAME,
T_ASSC.ASSC_CMS_ID AS AGENT_CMS_ID,
T_ASSC.ASSC_LGN_ID AS AGENT_LOGIN_ID,
T_ASSC.ASSC_LOB AS AGENT_LOB,
T_ASSC.ASSC_OFF_SITE_CITY AS AGENT_CITY,
(T_SUP.ASSC_FNM || ' ' || T_SUP.ASSC_LNM) AS SUPERVISOR_NAME,
T_SUP.ASSC_CMS_ID AS SUPERVISOR_CMS_ID,
T_SUP.ASSC_LGN_ID AS SUPERVISOR_LOGIN_ID,
T_SUP.ASSC_LOB AS SUPERVISOR_LOB,
T_SUP.ASSC_OFF_SITE_CITY AS SUPERVISOR_CITY,
(T_MAN.ASSC_FNM || ' ' || T_MAN.ASSC_LNM) AS MANAGER_NAME,
T_MAN.ASSC_CMS_ID AS MANAGER_CMS_ID,
T_MAN.ASSC_LGN_ID AS MANAGER_LOGIN_ID,
T_MAN.ASSC_LOB AS MANAGER_LOB,
T_MAN.ASSC_OFF_SITE_CITY AS MANAGER_CITY,
datediff(DAY,V_A.ACTIVATION_DATE, T_B.BKNG_DTTM) AS account_tenure,
(T_SEC_OWN.ASSC_FNM || ' ' || T_SEC_OWN.ASSC_LNM) AS secondary_owner,
T_OH.ORDR_ID_IN_SRC AS order_id
FROM EDW.DMART.BKNG T_B
	JOIN EDW.DMART.BKNG_TYP T_BT
		ON T_B.BKNG_TYP_ID = T_BT.BKNG_TYP_ID
	JOIN EDW.DMART.ORDR T_O
		ON T_B.ORDR_ID = T_O.ORDR_ID
			AND T_B.ACCT_ID = T_O.ACCT_ID
			AND T_B.PROD_ID = T_O.PROD_ID
	JOIN EDW.DMART.ORDR_HUB T_OH
		ON T_OH.ORDR_ID = T_O.ORDR_ID
	JOIN EDW.DMART.ORDR_TYP T_OT
		ON T_O.ORDR_TYP_ID =T_OT.ORDR_TYP_ID
	JOIN EDW_DEV.SANDBOX_AMITTAL.BI_ACCOUNT V_A
		ON T_B.ACCT_ID = V_A.ACCT_ID
			AND V_A.CURRENT_INDICATOR = 'Y'
			--AND T_B.SALE_DTTM between V_A.ACCT_STRT_DTTM AND coalesce(V_A.ACCT_END_DTTM, CURRENT_TIMESTAMP)
	JOIN EDW.DMART.PROD T_P
		ON T_B.PROD_ID = T_P.PROD_ID
			AND T_B.SALE_DTTM between T_P.PROD_STRT_DTTM AND coalesce(T_P.PROD_END_DTTM, CURRENT_TIMESTAMP)
			AND T_P.PROD_FMLY NOT ilike '%Fee%'
			AND T_P.PROD_CHRG_MDL NOT ilike '%Discount%'
	LEFT JOIN EDW.DMART.CMPGN T_C
		ON T_O.CMPGN_ID = T_C.CMPGN_ID
			AND T_B.SALE_DTTM between T_C.CMPGN_STRT_DTTM AND coalesce(T_C.CMPGN_END_DTTM, CURRENT_TIMESTAMP)
	LEFT JOIN EDW.DMART.ASSC T_ASSC
		ON T_B.AGNT_ASSC_ID = T_ASSC.ASSC_ID
			AND T_B.SALE_DTTM between T_ASSC.ASSC_STRT_DTTM AND coalesce(T_ASSC.ASSC_END_DTTM, CURRENT_TIMESTAMP)
	LEFT JOIN EDW.DMART.ASSC_HIER T_ASSC_HIER
		ON T_ASSC_HIER.ASSC_LVL_0_ID = T_ASSC.ASSC_ID
			AND T_ASSC_HIER.AS_OF_DT = cast(T_B.SALE_DTTM AS date)
	LEFT JOIN EDW.DMART.ASSC T_SUP
		ON T_ASSC_HIER.ASSC_LVL_1_ID = T_SUP.ASSC_ID
			AND T_B.SALE_DTTM BETWEEN T_SUP.ASSC_STRT_DTTM AND coalesce(T_SUP.ASSC_END_DTTM, CURRENT_TIMESTAMP)
	LEFT JOIN EDW.DMART.ASSC T_MAN
		ON T_ASSC_HIER.ASSC_LVL_2_ID = T_MAN.ASSC_ID
			AND T_B.SALE_DTTM BETWEEN T_MAN.ASSC_STRT_DTTM AND coalesce(T_MAN.ASSC_END_DTTM, CURRENT_TIMESTAMP)
	LEFT JOIN EDW.DMART.ASSC T_SEC_OWN
		ON V_A.SEC_OWNR_ASSC_ID = T_SEC_OWN.ASSC_ID
			AND T_B.SALE_DTTM between T_SEC_OWN.ASSC_STRT_DTTM AND coalesce(T_SEC_OWN.ASSC_END_DTTM, CURRENT_TIMESTAMP);
