CREATE OR REPLACE VIEW edw_dev.SANDBOX_AMITTAL.SMARTWAN_LIST as
select distinct
a.account_name,
a.account_number,
a.PARENT_ACCOUNT_NAME,
a.logo_seats,
b.total_mrr AS mrr,
datediff(DAY, account_start_date, current_date) AS account_tenure,
c.industry,
CASE WHEN package_name = 'Call Group' AND product_count<>0 THEN 'Yes' ELSE 'No' END AS call_group,
CASE WHEN package_name = 'Call Queue' AND product_count<>0 THEN 'Yes' ELSE 'No' END AS call_queue,
CASE WHEN package_name = 'Call Monitoring' AND product_count<>0 THEN 'Yes' ELSE 'No' END AS call_monitoring,
CASE WHEN package_name = 'Company Call Recording' AND product_count<>0 THEN 'Yes' ELSE 'No' END AS company_call_recording,
CASE WHEN package_name = 'BMobile Unlimited Extension Service' AND product_count<>0 THEN 'Yes' ELSE 'No' END AS mobile_unlimited_extensions,
CASE WHEN package_name = 'Business Number Inbox' AND product_count<>0 THEN 'Yes' ELSE 'No' END AS business_number_inbox,
CASE WHEN coalesce(c.num_virtual_reception,0) <> 0 THEN 'Yes' ELSE 'No' END AS virtual_reception,
CASE WHEN coalesce(c.num_monitor_whisper_barge,0) <> 0 THEN 'Yes' ELSE 'No' END AS monitor_whisper_barge
FROM EDW.MICROSTRATEGY.V_BI_VBC_SERVICE_MRR a
	-- mrr
	JOIN (SELECT account_number, sum(mrr) AS total_mrr FROM EDW.MICROSTRATEGY.V_BI_VBC_SERVICE_MRR WHERE month_id =201806 GROUP BY 1 HAVING sum(mrr) > 100) b
		ON a.account_number = b.account_number
	LEFT JOIN (SELECT account_number, industry, num_virtual_reception, num_monitor_whisper_barge FROM EDW.MICROSTRATEGY.V_BI_VBC_ACCT_PROFILE WHERE month_id =201807) c
		ON a.account_number = c.account_number
WHERE a.month_id = 201807 
AND a.logo_seats BETWEEN 10 AND 99
AND datediff(DAY, account_start_date, current_date) > 120
AND a.account_number IN (SELECT try_to_number(acct_num) FROM EDW.DMART.ACCT WHERE curr_rec_ind = 'Y' AND BUSS_TYP_ID = 1 AND acct_stat = 'Active')
AND a.account_number NOT IN (SELECT account_number FROM EDW.MICROSTRATEGY.V_BI_VBC_SERVICE_MRR WHERE package_name ilike '%SmartWAN%' GROUP BY 1)
AND a.account_number NOT IN (SELECT account_number FROM EDW.MICROSTRATEGY.V_BI_VBC_SERVICE_MRR WHERE package_name ilike '%White%' GROUP BY 1)
AND a.account_number NOT IN (SELECT account_number FROM EDW.MICROSTRATEGY.V_BI_VBC_SERVICE_MRR WHERE SECONDARY_AGENT_NAME IS NOT NULL GROUP BY 1)
AND a.account_number IN (SELECT account_id FROM EDW.BASEDW.VBS_HD_ACCOUNT_DATA WHERE coalesce(BILLING_COUNTRY, 'US') = 'US')
AND a.account_number NOT IN (20605,28571,31360,31406,32570,34798,35466,37757,39061,42431,50556,51717,53929,58031,59588,60293,61490,69559,70007,70271,70520,71325,72885,73776,73801,73947,82548,82866,83421,84332,88410,91007,92948,93906,93937,94816,96903,98181,98852,102794,103559,105364,106670,107040,107235,111259,111553,115048,117921,118063,120168,127354,128938,131574,131643,132531,132690,132759,134119,135542,137462,140920,141522,142337,142886,144205,144342,144512,146408,146837,146908,147361,149211,149725,150133,150135,150428,151529,152874,154052,155023,156621,158107,159488,159633,159667,159767,160412,161822,161964,162740,162763,163493,164062,164407,165026,165171,167444,168288,169169,169811,170157,170334,170528,171457,171460,171799,172512,172753,173612,173791,174297,175205,176146,178072,180805,181235,183005,183982,184643,186965,188344,189310,189882,190105,190194,190448,191059,191743,192281,192697,192943,193116,193512,193898,194099,194560,195327,195508,195921,196193,199136,200516,201688,202122,203508,10222,10248,10306,10328,10336,10503,10564,10600,10633,10747,10827,11095,11104,11221,11222,11260,11338,11397,11424,11481,11627,11776,11839,11841,11961,11974,12078,12107,12113,12184,12210,12238,12317,12472,12482,12516,12527,12598,12610,12696,12698,12720,12731,12775,12916,12964,13037,13120,13127,13159,13207,13302,13318,13328,13392,13403,13425,13426,13525,13529,13549,13729,20007,20471,20928,21057,21147,21238,21274,21280,21417,21459,21528,21533,25118,25125,25144,25297,25305,25338,25396,25731,25747,25931,26176,26532,26688,26725,26866,27069,27146,27248,27254,27353,27354,27363,27508,27529,27653,27666,27685,27809,27838,28108,28519,28903,29245,29434,29600,30039,31014,31182,31276,31277,31364,31765,32002,32157,32167,32228,32347,32407,32470,32503,32557,32564,32649,32695,32698,33009,33053,33063,33112,33200,33210,33430,33455,33567,33652,34120,34192,34209,34223,34244,34407,34446,34629,34871,34929,34988,10013,10029,10033,10054,10061,10069,10072,10084,10091,10123,10144,10149,10176,10180,10186,10190,10191,10210,10227,10265,10270,10285,10315,10369,10412,10462,10488,10490,10495,10501,10513,10535,10543,10558,10562,10573,10580,10593,10595,10597,10611,10612,10671,10685,10694,10708,10710,10712,10717,10753,10762,10763,10777,10780,10781,10783,10824,10828,10831,10853,10866,10869,10870,10927,10951,10991,10998,11005,11030,11036,11077,11085,11103,11128,11139,11177,11192,11218,11219,11220,11237,11281,11294,11296,11308,11340,11352,11379,11385,11392,11395,11396,11422,11434,11454,11486,11491,11499,11501,11506,11513,11620,11646,11676,11719,11724,11737,11740,11744,11801,11805,11821,11824,11828,11840,11844,11858,11901,11903,11904,11910,11919,11923,11930,11942,11959,11960,11973,11982,12006,12013,12025,12116,12148,12157,12165,12185,12189,12202,12223,12229,12248,12277,12283,12294,12313,12323,12343,12346,12365,12369,12400,12418,12424,12442,12450,12452,12453,12455,12476,12554,12591,12640,12642,12648,12650,12652,12676,12691,12700,12704,12705,12710,12714,12722,12724,12730,12750,12761,12800,12804,12810,12821,12833,12839,12840,12882,12891,12892,12907,12918,12959,12971,12974,12975,12988,13023,13026,13040,13042,13043,13044,13051,13059,13090,13102,13109,13119,13142,13169,13194,13197,13199,13210,13211,13223,13224,13234,13264,13270,13271,13280,13284,13291,13297,13298,13309,13312,13330,13351,13354,13358,13391,13394,13399,13433,13444,13450,13461,13466,13482,13489,13517,13521,13557,13563,13568,13581,13587,13593,13597,13607,13610,13628,13633,13649,13650,13658,13664,13668,13690,13698,13710,13718,13735,13743,13745,13835,20138,20468,20610,20642,20740,20795,20839,21036,21135,21142,21176,21248,21521,25233,25442,25462,25469,25512,25620,25652,25654,25704,25768,25880,25957,26011,26177,26449,26466,26583,26811,26879);


GRANT SELECT ON ALL VIEWS in SCHEMA EDW_DEV.SANDBOX_AMITTAL TO ROLE AP_TABLEAU;

SELECT * FROM edw_dev.SANDBOX_AMITTAL.SMARTWAN_LIST
